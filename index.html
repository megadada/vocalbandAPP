<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë³´ì»¬ ìºë¦­í„° ëŠ¥ë ¥ì¹˜ ë¶„ì„</title>
    <!-- Tailwind CSS CDN --><script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ --><script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Google Fonts --><link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Plus Jakarta Sans', 'Noto Sans KR', sans-serif;
            background-color: #F3F4F6;
            color: #1F2937;
            /* ëª¨ë°”ì¼ í™”ë©´ì—ì„œ ì „ì²´ ìŠ¤í¬ë¡¤ ë°©ì§€ */
            overflow: hidden; 
            touch-action: none;
        }

        .app-card {
            border-radius: 2rem;
            box-shadow: 0 20px 60px -15px rgba(0,0,0,0.1);
        }
        
        /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .scale-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .scale-btn:active { transform: scale(0.96); }

        /* ë²¤í†  ê·¸ë¦¬ë“œ ì•„ì´í…œ í˜¸ë²„ íš¨ê³¼ */
        .bento-item { transition: transform 0.2s, box-shadow 0.2s; }
        .bento-item:active { transform: scale(0.98); }

        canvas { max-width: 100%; }
        button { touch-action: manipulation; }
        
        /* í•œê¸€ í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ë°©ì§€ */
        .word-keep-all { word-break: keep-all; overflow-wrap: break-word; } 
    </style>
</head>
<!-- í™”ë©´ ì¤‘ì•™ ì •ë ¬ ë° ë°°ê²½ ê³ ì • --><body class="h-[100dvh] w-screen flex items-center justify-center bg-gray-100 overflow-hidden">

    <!-- App Container: ë†’ì´ë¥¼ í™”ë©´ì— ë”± ë§ì¶”ê±°ë‚˜ ìµœëŒ€ 850pxë¡œ ê³ ì • --><div id="app" class="w-full max-w-[420px] h-full max-h-[100dvh] sm:h-[850px] sm:max-h-[95vh] bg-white relative sm:rounded-[2rem] overflow-hidden flex flex-col shadow-2xl">
        <!-- App Content renders here --></div>

    <script>
        // --- ì „ì—­ ë°ì´í„° ë° ìƒíƒœ ---
        const APP_STATE = {
            SESSION_SELECT: 'SESSION_SELECT',
            TEST_IN_PROGRESS: 'TEST_IN_PROGRESS',
            RESULT_VIEW: 'RESULT_VIEW'
        };

        let currentState = APP_STATE.SESSION_SELECT;
        let currentSession = null;
        let currentQuestionIndex = 0;
        let currentAnswers = [];
        
        let characterImage = null;
        let characterName = "ë³´ì»¬ë§¨";
        let catchphrase = "ìµœê³ ì˜ ë…¸ë˜ë¥¼ ë“¤ë ¤ì¤„ê²Œ!";

        // ë‹¤ë¥¸ ì„¸ì…˜ ë°ì´í„° ì‚­ì œ, ë³´ì»¬ë§Œ ìœ ì§€
        const sessionData = {
            'Vocal': {
                name: 'ë³´ì»¬', engName: 'Vocal',
                theme: 'bg-purple-100 text-purple-600 border-purple-200',
                activeColor: '#9333ea', lightColor: '#f3e8ff',
                // ì§ˆë¬¸ ë°ì´í„° ìœ ì§€
                questions: [
                    "ìŒì • ì •í™•ë„(Pitch)ë¥¼ í•­ìƒ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤.", "ë¦¬ë“¬ì„ ì •í™•íˆ ë”°ë¼ê°€ê³  ë°•ì ì‹¤ìˆ˜ê°€ ì ìŠµë‹ˆë‹¤.", "ì¥ì‹œê°„ ê³µì—° ì¤‘ì—ë„ í˜¸í¡ ì¡°ì ˆì´ ííŠ¸ëŸ¬ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.", "ì„±ëŸ‰ ë³€í™”(ë‹¤ì´ë‚´ë¯¹)ë¥¼ ììœ ìì¬ë¡œ í‘œí˜„í•©ë‹ˆë‹¤.", "ê³ ìŒì—­ëŒ€ ì²˜ë¦¬ê°€ ê¹”ë”í•˜ê³  í˜ì´ ì‹¤ë ¤ ìˆìŠµë‹ˆë‹¤.", "ì €ìŒì—­ëŒ€ì—ì„œë„ ì•ˆì •ì ì¸ ì†Œë¦¬ë¥¼ ëƒ…ë‹ˆë‹¤.", "ë¹„ë¸Œë¼í† ë¥¼ ì›í•˜ëŠ” ëŒ€ë¡œ ì¡°ì ˆí•˜ë©° êµ¬ì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", "ë‹¤ì–‘í•œ ë°œì„± í…Œí¬ë‹‰(ì˜ˆ: ìŠ¤í¬ë˜ì¹˜, ë²¨íŒ…)ì— ëŠ¥ìˆ™í•©ë‹ˆë‹¤.", "ë²¨íŒ…ê³¼ ë¯¹ìŠ¤ ë³´ì´ìŠ¤ êµ¬ì‚¬ì— ëŠ¥ìˆ™í•©ë‹ˆë‹¤.", "ìŠ¤í¬ë˜ì¹˜ë‚˜ í—ˆìŠ¤í‚¤ ë³´ì´ìŠ¤ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ í™œìš©í•©ë‹ˆë‹¤.", "ê°€ì„±(íŒ”ì„¸í† )ì„ ê¹¨ë—í•˜ê³  ì•ˆì •ì ìœ¼ë¡œ ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.", "ë‹¤ì–‘í•œ ê°•ì•½ ì¡°ì ˆ(ë‹¤ì´ë‚´ë¯¹) í‘œí˜„ì´ ë§¤ìš° í’ë¶€í•©ë‹ˆë‹¤.", "ê°€ì‚¬ ì „ë‹¬ë ¥ì´ ë›°ì–´ë‚˜ ì²­ì¤‘ì—ê²Œ ëª…í™•íˆ ë©”ì‹œì§€ë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤.", "ë…¸ë˜ì— ê°ì •ì„ ê¹Šì´ ì´ì…í•˜ì—¬ í‘œí˜„í•©ë‹ˆë‹¤.", "ì¦‰í¥ì ì¸ ì• ë“œë¦½ì´ë‚˜ ë©œë¦¬ìŠ¤ë§ˆì— ëŠ¥ìˆ™í•©ë‹ˆë‹¤.", "ë¬´ëŒ€ ë§¤ë„ˆì™€ ì¹´ë¦¬ìŠ¤ë§ˆë¡œ ì²­ì¤‘ì„ ì••ë„í•©ë‹ˆë‹¤.", "ê´€ê° ì†Œí†µ(ë©˜íŠ¸, í˜¸ì‘ ìœ ë„)ì— ì ê·¹ì ì´ê³  ë›°ì–´ë‚©ë‹ˆë‹¤.", "ë§ˆì´í¬ë¥¼ ì‚¬ìš©í•˜ëŠ” ê¸°ìˆ (ê±°ë¦¬, ê°ë„)ì´ ì™„ë²½í•©ë‹ˆë‹¤.", "ëª¨ë‹ˆí„°ë§ ì‚¬ìš´ë“œë¥¼ ë¹ ë¥´ê²Œ íŒŒì•…í•˜ê³  ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", "ë‹¤ì–‘í•œ ì¥ë¥´(ë½, ë°œë¼ë“œ, R&B ë“±)ì˜ ë…¸ë˜ë¥¼ ì†Œí™”í•©ë‹ˆë‹¤.", "í™”ìŒ(í•˜ëª¨ë‹ˆ)ì„ ë“£ê³  ë°”ë¡œ ë”°ë¼ ë¶€ë¥´ê±°ë‚˜ ë§Œë“¤ì–´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.", "ë©œë¡œë””ë¥¼ ë“¤ì—ˆì„ ë•Œ ê·¸ ì˜ë„ì™€ íë¦„ì„ ë¹ ë¥´ê²Œ í•´ì„í•©ë‹ˆë‹¤.", "ì²­ìŒë§Œìœ¼ë¡œ ë³µì¡í•œ ë…¸ë˜ë¥¼ ì¹´í”¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", "ìŒì•… ì´ë¡ (í™”ì„±í•™) ì§€ì‹ì´ í’ë¶€í•©ë‹ˆë‹¤.", "ê°€ì°½ ì¤‘ ë”•ì…˜(ë°œìŒ)ì´ ì •í™•í•˜ê³  ëª…ë£Œí•©ë‹ˆë‹¤.", "ì¥ì‹œê°„ ë…¸ë˜í•´ë„ ëª©ì— ë¬´ë¦¬ê°€ ì—†ê³  ì§€êµ¬ë ¥ì´ ì¢‹ìŠµë‹ˆë‹¤.", "ì»¨ë””ì…˜ ê´€ë¦¬ë¥¼ ìœ„í•œ ìì‹ ë§Œì˜ ë£¨í‹´ì´ í™•ì‹¤í•©ë‹ˆë‹¤.", "ë‹¤ë¥¸ ì„¸ì…˜ì˜ ì—°ì£¼ì™€ ì™„ë²½í•˜ê²Œ ì¡°í™”ë©ë‹ˆë‹¤.", "í™”ì„±í•™ ì§€ì‹ì„ ê¸°ë°˜ìœ¼ë¡œ ì¦‰í¥ì ì¸ ë©œë¡œë””ë¥¼ ë§Œë“­ë‹ˆë‹¤.", "ì§ì ‘ ì‘ì‚¬ ëŠ¥ë ¥ì´ ë›°ì–´ë‚˜ë©°, í‘œí˜„ë ¥ì´ ì¢‹ìŠµë‹ˆë‹¤."
                ],
                axes: ['ê¸°ë³¸ê¸°', 'í…Œí¬ë‹‰', 'ì´ë¡ /ì²­ìŒ', 'ë¬´ëŒ€ë§¤ë„ˆ', 'ì¥ë¹„ìš´ìš©', 'ì°½ì‘ë ¥'],
                axisMap: [[0,1,2,3,24], [4,5,6,7,8,9,10], [20,21,22,23,28], [15,16,25,27], [17,18,19,26], [11,12,13,14,29]]
            }
        };

        const sessionIcons = {
            'Vocal': 'ğŸ¤'
        };

        const appElement = document.getElementById('app');

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í‚¤
        const STORAGE_KEY_PREFIX = 'BAND_CHAR_ANALYSIS_';

        // --- ë Œë”ë§ í•¨ìˆ˜ ---

        function renderApp() {
            appElement.innerHTML = '';
            
            // ê²°ê³¼ í™”ë©´ìœ¼ë¡œ ëŒì•„ì™”ì„ ë•Œ ë ˆì´ë” ì°¨íŠ¸ë¥¼ ë‹¤ì‹œ ê·¸ë ¤ì•¼ í•˜ë¯€ë¡œ,
            // ë Œë”ë§ í›„ ë¹„ë™ê¸°ë¡œ ì°¨íŠ¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
            if (currentState === APP_STATE.SESSION_SELECT) {
                renderSessionSelect();
            } else if (currentState === APP_STATE.TEST_IN_PROGRESS) {
                renderTestInProgress();
            } else if (currentState === APP_STATE.RESULT_VIEW) {
                renderResultView();
                // DOMì´ êµ¬ì„±ëœ í›„ ì°¨íŠ¸ ê·¸ë¦¬ê¸° ì‹¤í–‰
                setTimeout(() => {
                    const data = sessionData[currentSession];
                    const stats = calculateStats(currentAnswers);
                    drawRadarChart('radar-chart', stats, data.axes, data.activeColor, data.lightColor);
                    updateCharacterInfoDisplay();
                }, 50);
            }
        }

        // 1. ì„¸ì…˜ ì„ íƒ í™”ë©´ (ë³´ì»¬ë§Œ ë‚¨ê¹€, ë¹ˆ ê³µê°„ ì œê±°)
        function renderSessionSelect() {
            
            const content = `
                <div class="h-full flex flex-col p-6 bg-white">
                    
                    <!-- 1. Header Area (ë†’ì´ ê³ ì •) --><div class="flex-none mb-6">
                        <div class="flex items-center mb-4">
                            <span class="p-2 rounded-full bg-gray-100 text-gray-500">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                            </span>
                            <span class="ml-2 font-bold text-gray-400 text-sm tracking-wider uppercase">Band Analysis</span>
                        </div>
                        <h1 class="text-3xl font-extrabold text-gray-900 leading-tight word-keep-all">
                            ë‹¹ì‹ ì˜ ë³´ì»¬ ëŠ¥ë ¥ì¹˜ë¥¼<br>ê²€ì‚¬í•´ë³´ì„¸ìš”.
                        </h1>
                    </div>

                    <!-- 2. Bento Grid Area (ë‚¨ì€ ê³µê°„ ëª¨ë‘ ì‚¬ìš©) -->
                    <div class="flex-1 grid grid-cols-2 grid-rows-3 gap-3 min-h-0">
                        
                        <!-- ë³´ì»¬ (ê°€ì¥ í¼, ìƒë‹¨ ì „ì²´, 1í–‰ë§Œ ì°¨ì§€í•˜ë„ë¡ ìˆ˜ì • - ì›ë˜ ë””ìì¸ ìœ ì§€) -->
                        <button onclick="startTest('Vocal')" 
                            class="col-span-2 row-span-1 bento-item relative rounded-3xl bg-purple-100 text-purple-700 p-6 flex flex-col items-start justify-start overflow-hidden group border-2 border-transparent hover:border-purple-300">
                            <div class="flex flex-col items-start z-10">
                                <span class="font-extrabold text-3xl sm:text-4xl">ë³´ì»¬</span>
                                <span class="text-base font-semibold opacity-80 mt-1">Vocal</span>
                            </div>
                            <!-- ì•„ì´ì½˜ì„ ì ˆëŒ€ ìœ„ì¹˜ë¡œ ê³ ì •í•˜ì—¬ í…ìŠ¤íŠ¸ ê³µê°„ ì¹¨ë²” ë°©ì§€ --><div class="text-8xl absolute bottom-[-1rem] right-[-1rem] opacity-40 transform group-hover:scale-105 transition-transform duration-300">ğŸ¤</div>
                        </button>

                        <!-- ë‚˜ë¨¸ì§€ ì„¸ì…˜ ë²„íŠ¼ ì‚­ì œë¨, ë¹ˆ ê³µê°„ì€ ìœ ì§€ë¨ -->
                    </div>

                    <!-- Footer Text --><div class="flex-none mt-4 text-center">
                        <p class="text-xs text-gray-400 font-medium">ì„ íƒ ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ê°€ ì‹œì‘ë©ë‹ˆë‹¤</p>
                    </div>
                </div>
            `;
            appElement.innerHTML = content;
        }

        // 2. í…ŒìŠ¤íŠ¸ ì§„í–‰ í™”ë©´ (ìŠ¤í¬ë¡¤ ìµœì í™”)
        function renderTestInProgress() {
            const data = sessionData[currentSession];
            const totalQ = data.questions.length;
            const currentQText = data.questions[currentQuestionIndex];
            const progress = ((currentQuestionIndex + 1) / totalQ) * 100;
            
            // ì´ì „ ì§ˆë¬¸ìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€
            const isFirstQuestion = currentQuestionIndex === 0;

            const scales = [
                { val: 1, label: 'ì „í˜€ ì•„ë‹˜' },
                { val: 2, label: 'ì•„ë‹˜' },
                { val: 3, label: 'ë³´í†µ' },
                { val: 4, label: 'ê·¸ë ‡ë‹¤' },
                { val: 5, label: 'ë§¤ìš° ê·¸ë ‡ë‹¤' }
            ];

            const content = `
                <div class="flex flex-col h-full bg-gray-50 relative">
                    <!-- Top Bar --><div class="flex-none px-6 py-5 flex items-center justify-between bg-white z-10">
                        <button onclick="goBack()" ${isFirstQuestion ? 'disabled' : ''} class="p-2 -ml-2 rounded-full hover:bg-gray-100 text-gray-600 ${isFirstQuestion ? 'opacity-30 cursor-not-allowed' : ''}">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
                        </button>
                        <div class="flex flex-col items-center">
                            <span class="font-bold text-lg text-gray-900 leading-none">${data.name}</span>
                            <span class="text-xs text-gray-400 font-medium mt-1">${currentQuestionIndex + 1} / ${totalQ}</span>
                        </div>
                        <!-- í™ˆ ë²„íŠ¼ --><button onclick="goHome()" class="p-2 -mr-2 rounded-full hover:bg-gray-100 text-gray-600">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                        </button>
                    </div>

                    <!-- Progress Line --><div class="flex-none w-full h-1 bg-gray-100">
                        <div class="h-full bg-gray-900 transition-all duration-300" style="width: ${progress}%"></div>
                    </div>

                    <!-- Scrollable Question Area --><div class="flex-1 overflow-y-auto no-scrollbar p-6 pb-20 flex flex-col">
                        <!-- Question Card --><div class="flex-none bg-white rounded-[2rem] p-8 shadow-sm border border-gray-100 mb-6 min-h-[160px] flex flex-col justify-center items-center text-center">
                            <span class="inline-block px-3 py-1 rounded-full ${data.theme} text-xs font-bold mb-3">
                                Question ${currentQuestionIndex + 1}
                            </span>
                            <p class="text-xl sm:text-2xl font-bold text-gray-800 leading-snug word-keep-all">
                                ${currentQText}
                            </p>
                        </div>

                        <!-- Answer Buttons (Vertical Stack) --><div class="flex-1 flex flex-col justify-center space-y-3">
                            ${scales.map((item) => {
                                const isSelected = currentAnswers[currentQuestionIndex] === item.val;
                                const activeClass = isSelected 
                                    ? `bg-gray-900 text-white border-gray-900 shadow-md ring-2 ring-gray-900 ring-offset-2` 
                                    : `bg-white text-gray-600 border-gray-200 hover:border-gray-400 hover:bg-gray-50`;

                                return `
                                    <button onclick="recordAnswer(${item.val})" class="w-full py-3.5 px-6 rounded-2xl border-2 flex items-center justify-between transition-all duration-200 scale-btn group ${activeClass}">
                                        <span class="text-sm font-bold opacity-80">${item.label}</span>
                                        <span class="text-lg font-black font-mono">${item.val}</span>
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
            appElement.innerHTML = content;
        }

        // 3. ê²°ê³¼ í™”ë©´
        function renderResultView() {
            const data = sessionData[currentSession];
            const stats = calculateStats(currentAnswers);
            const themeColor = data.activeColor;
            
            // ì¶• ë ˆì´ë¸” ë° ê°’ í‘œì‹œ
            const axisElements = data.axes.map((axisName, index) => {
                const score = stats.scores[index];
                const scorePercent = score.toFixed(0);
                
                // ë§‰ëŒ€ ìƒ‰ìƒ ê³„ì‚°
                const barColor = `background-color: ${themeColor}`;
                
                return `
                    <div class="flex flex-col py-2">
                        <div class="flex justify-between items-center mb-1">
                            <!-- ìˆ˜ì •: í…ìŠ¤íŠ¸ í¬ê¸°ë¥¼ text-xsë¡œ ì¤„ì„ (text-sm -> text-xs) -->
                            <span class="text-xs font-semibold text-gray-700">${axisName}</span>
                            <!-- ìˆ˜ì •: í…ìŠ¤íŠ¸ í¬ê¸°ë¥¼ text-xsë¡œ ì¤„ì„ (text-sm -> text-xs) -->
                            <span class="text-xs font-extrabold" style="color: ${themeColor};">${scorePercent}</span>
                        </div>
                        <div class="h-2 w-full rounded-full bg-gray-100 overflow-hidden">
                            <div class="h-full rounded-full" style="${barColor}; width: ${scorePercent}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
            
            const content = `
                <div class="h-full flex flex-col bg-gray-50 overflow-hidden">
                    <!-- Header --><div class="flex-none px-6 py-5 flex justify-between items-center bg-white border-b border-gray-100 z-10">
                        <h1 class="text-xl font-extrabold text-gray-900">ë¶„ì„ ê²°ê³¼</h1>
                        <button onclick="exportResultAsImage()" class="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-gray-100 text-xs font-bold text-gray-600 hover:bg-gray-200 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            ì €ì¥
                        </button>
                    </div>

                    <!-- Scrollable Content --><div class="flex-1 overflow-y-auto no-scrollbar bg-gray-50 relative">
                        <!-- Capture Area --><div id="result-capture-area" class="px-6 py-6 pb-24 bg-gray-50 min-h-full">
                            
                            <!-- Profile Section -->
                            <div class="bg-white rounded-[2rem] p-5 shadow-sm border border-gray-100 mb-4 flex items-center gap-4">
                                <!-- ìˆ˜ì •: ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ í¬ê¸°ë¥¼ w-24 h-24ë¡œ í‚¤ì›Œ ì‹œì¸ì„± í–¥ìƒ -->
                                <div class="relative w-24 h-24 flex-shrink-0 cursor-pointer group" onclick="triggerFileInput()">
                                    <input type="file" id="image-upload" accept="image/*" class="hidden" onchange="handleFileSelect(event)">
                                    <div id="char-image-display" class="w-full h-full rounded-full overflow-hidden border-2 border-gray-100 bg-gray-100 flex items-center justify-center text-3xl">
                                        ${characterImage 
                                            ? `<img src="${characterImage}" class="w-full h-full object-cover">` 
                                            : `ğŸ˜`}
                                    </div>
                                    <div class="absolute inset-0 rounded-full bg-black bg-opacity-0 group-hover:bg-opacity-20 flex items-center justify-center transition duration-300">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-white opacity-0 group-hover:opacity-100" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5l-3.5 3.5 6 6 3.5-3.5z"/><path d="M19 14l-6 6"/><path d="M8 8H5a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-3"/></svg>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-xl font-extrabold text-gray-900" id="char-name-display" contenteditable="true" onblur="updateCharacterName(this.innerText)">${characterName}</span>
                                        <!-- ìˆ˜ì •: html2canvas ìº¡ì²˜ ì‹œ ë ˆì´ì•„ì›ƒ ê¹¨ì§ ë°©ì§€ë¥¼ ìœ„í•œ ìŠ¤íƒ€ì¼ ì ìš© -->
                                        <span class="inline-block px-3 py-0.5 rounded-full text-xs font-bold align-middle leading-tight" style="color: ${themeColor}; background-color: ${data.lightColor}; display: inline-block;">${data.name}</span>
                                    </div>
                                    <p class="text-sm text-gray-500 word-keep-all" id="char-catchphrase-display" contenteditable="true" onblur="updateCatchphrase(this.innerText)">${catchphrase}</p>
                                </div>
                            </div>

                            <!-- Radar Chart Section --><div class="bg-white rounded-[2rem] p-5 shadow-sm border border-gray-100 mb-4">
                                <h2 class="text-lg font-extrabold text-gray-900 mb-4 border-b pb-2 border-gray-100">ëŠ¥ë ¥ì¹˜ ë ˆì´ë” ë¶„ì„</h2>
                                <!-- ìˆ˜ì •: ìº”ë²„ìŠ¤ ë„ˆë¹„ì™€ ë†’ì´ë¥¼ ì•½ê°„ ëŠ˜ë¦¼ -->
                                <canvas id="radar-chart" width="320" height="320" class="mx-auto"></canvas>
                            </div>

                            <!-- Score Bars Section --><div class="bg-white rounded-[2rem] p-5 shadow-sm border border-gray-100">
                                <h2 class="text-lg font-extrabold text-gray-900 mb-2 border-b pb-2 border-gray-100">ì„¸ë¶€ ìŠ¤ì½”ì–´ (Max 100)</h2>
                                ${axisElements}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fixed Footer --><div class="flex-none p-4 bg-white border-t border-gray-100 absolute bottom-0 w-full">
                         <button onclick="goHome()" class="w-full py-3 rounded-2xl bg-gray-900 text-white font-bold text-lg scale-btn shadow-lg hover:bg-gray-800 transition-colors">
                            ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•˜ê¸°
                        </button>
                    </div>
                </div>
            `;
            appElement.innerHTML = content;
        }

        // --- ê¸°ëŠ¥ í•¨ìˆ˜ ---

        // ìƒíƒœ ì´ˆê¸°í™” ë° í…ŒìŠ¤íŠ¸ ì‹œì‘ (ìˆ˜ì •ë¨: í•­ìƒ ìƒˆë¡œ ì‹œì‘)
        function startTest(sessionKey) {
            currentSession = sessionKey;
            currentState = APP_STATE.TEST_IN_PROGRESS;
            currentQuestionIndex = 0;
            currentAnswers = [];
            
            // [ì¤‘ìš” ìˆ˜ì •] ì‹œì‘ ì‹œ ë¡œì»¬ ì €ì¥ì†Œì˜ ì´ì „ ê¸°ë¡ì„ ì‚­ì œí•˜ì—¬ í•­ìƒ ìƒˆë¡œ ì‹œì‘í•˜ë„ë¡ í•¨
            try {
                localStorage.removeItem(STORAGE_KEY_PREFIX + sessionKey);
            } catch (e) { console.error("Local storage clear failed", e); }
            
            // ìºë¦­í„° ì •ë³´ë„ ì´ˆê¸°í™”
            characterImage = null;
            characterName = "ë³´ì»¬ë§¨";
            catchphrase = "ìµœê³ ì˜ ë…¸ë˜ë¥¼ ë“¤ë ¤ì¤„ê²Œ!";
            
            // ì´ì „ ì½”ë“œì—ì„œ loadResultLocally í˜¸ì¶œì„ ì œê±°í•¨
            renderApp();
        }
        
        // ì´ì „ ì§ˆë¬¸ìœ¼ë¡œ ì´ë™
        function goBack() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderApp();
            } else {
                // ì²« ì§ˆë¬¸ì—ì„œ ë’¤ë¡œ ê°€ê¸° ì‹œ ì„¸ì…˜ ì„ íƒ í™”ë©´ìœ¼ë¡œ ì´ë™
                goHome();
            }
        }
        
        // í™ˆ í™”ë©´ìœ¼ë¡œ ì´ë™ (í…ŒìŠ¤íŠ¸ ì´ˆê¸°í™”)
        function goHome() {
            currentState = APP_STATE.SESSION_SELECT;
            currentSession = null;
            currentQuestionIndex = 0;
            currentAnswers = [];
            characterImage = null;
            characterName = "ë³´ì»¬ë§¨";
            catchphrase = "ìµœê³ ì˜ ë…¸ë˜ë¥¼ ë“¤ë ¤ì¤„ê²Œ!";
            renderApp();
        }

        // ë‹µë³€ ê¸°ë¡ ë° ë‹¤ìŒ ì§ˆë¬¸ìœ¼ë¡œ ì´ë™
        function recordAnswer(score) {
            currentAnswers[currentQuestionIndex] = score;
            
            if (currentQuestionIndex < sessionData[currentSession].questions.length - 1) {
                currentQuestionIndex++;
                renderApp();
            } else {
                // í…ŒìŠ¤íŠ¸ ì™„ë£Œ
                currentState = APP_STATE.RESULT_VIEW;
                saveResultLocally(currentSession); // ê²°ê³¼ ì €ì¥
                renderApp();
            }
        }

        // ëŠ¥ë ¥ì¹˜ ê³„ì‚° (Max 100ì  ìŠ¤ì¼€ì¼)
        function calculateStats(answers) {
            if (!currentSession || answers.length === 0) return { avgScore: 0, scores: [] };

            const data = sessionData[currentSession];
            const stats = [];
            let totalScore = 0;
            let totalQuestionsCount = 0;

            data.axisMap.forEach((qIndices) => {
                let axisSum = 0;
                let axisCount = 0;
                
                qIndices.forEach(qIndex => {
                    const answer = answers[qIndex];
                    if (answer !== undefined) {
                        axisSum += answer;
                        axisCount++;
                        // ì „ì²´ í•©ì‚°ì—ë„ ê¸°ì—¬
                        totalScore += answer;
                        totalQuestionsCount++;
                    }
                });
                
                // 5ì  ë§Œì  í‰ê· ì„ 100ì  ë§Œì  ì ìˆ˜ë¡œ ë³€í™˜ (max score of 5 -> 100)
                const axisAverage = axisCount > 0 ? axisSum / axisCount : 0;
                const scaledScore = (axisAverage / 5) * 100;
                stats.push(scaledScore);
            });

            const overallAverage = totalQuestionsCount > 0 ? totalScore / totalQuestionsCount : 0;
            const overallScaledScore = (overallAverage / 5) * 100;

            return { 
                avgScore: overallScaledScore, 
                scores: stats 
            };
        }

        // ë ˆì´ë” ì°¨íŠ¸ ê·¸ë¦¬ê¸°
        function drawRadarChart(canvasId, stats, axes, themeColor, lightColor) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const numAxes = axes.length;
            const angle = (Math.PI * 2) / numAxes;
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            // ìˆ˜ì •: ì°¨íŠ¸ í¬ê¸°ë¥¼ ì¤„ì—¬(0.75 -> 0.65) í…ìŠ¤íŠ¸ì™€ ê°„ê²© í™•ë³´
            const maxRadius = (Math.min(canvas.width, canvas.height) / 2) * 0.65;
            const scores = stats.scores; // 100ì  ë§Œì  ì ìˆ˜ ë°°ì—´

            // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ë³´ì¡°ì„  (ê·¸ë¦¬ë“œ) ê·¸ë¦¬ê¸° - 5ë‹¨ê³„
            for (let i = 1; i <= 5; i++) {
                const radius = (i / 5) * maxRadius;
                ctx.beginPath();
                for (let j = 0; j < numAxes; j++) {
                    const x = centerX + radius * Math.cos(angle * j - Math.PI / 2);
                    const y = centerY + radius * Math.sin(angle * j - Math.PI / 2);
                    if (j === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.strokeStyle = lightColor;
                ctx.lineWidth = i === 5 ? 2 : 1; // ê°€ì¥ ë°”ê¹¥ìª½ ì„ ì„ ë‘ê»ê²Œ
                ctx.stroke();
            }
            
            // ì¶• ì„  ê·¸ë¦¬ê¸°
            ctx.strokeStyle = '#E5E7EB';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]); // ì ì„ 
            for (let i = 0; i < numAxes; i++) {
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                const x = centerX + maxRadius * Math.cos(angle * i - Math.PI / 2);
                const y = centerY + maxRadius * Math.sin(angle * i - Math.PI / 2);
                ctx.lineTo(x, y);
                ctx.stroke();
            }
            ctx.setLineDash([]); // ì ì„  í•´ì œ

            // ë°ì´í„° ì˜ì—­ ê·¸ë¦¬ê¸°
            ctx.beginPath();
            ctx.fillStyle = hexToRgba(themeColor, 0.5); // 50% íˆ¬ëª…ë„
            ctx.strokeStyle = themeColor;
            ctx.lineWidth = 3;

            scores.forEach((score, i) => {
                const radius = (score / 100) * maxRadius;
                const x = centerX + radius * Math.cos(angle * i - Math.PI / 2);
                const y = centerY + radius * Math.sin(angle * i - Math.PI / 2);
                
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });

            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // ê¼­ì§“ì  ì› ê·¸ë¦¬ê¸° (ë§¤ìš° ì‘ì€ ì›)
            ctx.fillStyle = themeColor;
            scores.forEach((score, i) => {
                const radius = (score / 100) * maxRadius;
                const x = centerX + radius * Math.cos(angle * i - Math.PI / 2);
                const y = centerY + radius * Math.sin(angle * i - Math.PI / 2);
                
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, Math.PI * 2); // ê¼­ì§“ì  ì› í¬ê¸° 3px
                ctx.fill();
            });

            // ì¶• ë ˆì´ë¸” ê·¸ë¦¬ê¸°
            ctx.fillStyle = '#1F2937';
            ctx.font = '700 12px "Noto Sans KR", sans-serif'; // Noto Sans KR í°íŠ¸, êµµê²Œ
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            axes.forEach((axisName, i) => {
                // ìˆ˜ì •: ì°¨íŠ¸ í¬ê¸° ì¶•ì†Œë¡œ ì¸í•´ ë ˆì´ë¸” ê°„ê²©(15 -> 20) ì•½ê°„ ì¦ê°€
                const labelOffset = maxRadius + 20; 
                const x = centerX + labelOffset * Math.cos(angle * i - Math.PI / 2);
                const y = centerY + labelOffset * Math.sin(angle * i - Math.PI / 2);
                
                ctx.fillText(axisName, x, y);
            });
        }

        // Hex ìƒ‰ìƒì„ RGBAë¡œ ë³€í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ íŠ¸ë¦¬ê±°
        function triggerFileInput() {
            document.getElementById('image-upload').click();
        }

        // ì´ë¯¸ì§€ íŒŒì¼ ì²˜ë¦¬
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    characterImage = e.target.result;
                    document.getElementById('char-image-display').innerHTML = 
                        `<img src="${characterImage}" class="w-full h-full object-cover">`;
                    saveResultLocally(currentSession);
                };
                reader.readAsDataURL(file);
            }
        }
        
        // ìºë¦­í„° ì´ë¦„ ì—…ë°ì´íŠ¸
        function updateCharacterName(newName) {
            characterName = newName || "ë³´ì»¬ë§¨";
            saveResultLocally(currentSession);
        }

        // ìºì¹˜í”„ë ˆì´ì¦ˆ ì—…ë°ì´íŠ¸
        function updateCatchphrase(newCatchphrase) {
            catchphrase = newCatchphrase || "ìµœê³ ì˜ ë…¸ë˜ë¥¼ ë“¤ë ¤ì¤„ê²Œ!";
            saveResultLocally(currentSession);
        }

        // ìº¡ì²˜ ì˜ì—­ ì—…ë°ì´íŠ¸ (ì´ë¦„/ë¬¸êµ¬ ë³€ê²½ ì‹œ ê²°ê³¼ í™”ë©´ì—ì„œ ì¦‰ì‹œ ë°˜ì˜)
        function updateCharacterInfoDisplay() {
            const nameEl = document.getElementById('char-name-display');
            const catchphraseEl = document.getElementById('char-catchphrase-display');
            
            if (nameEl) nameEl.innerText = characterName;
            if (catchphraseEl) catchphraseEl.innerText = catchphrase;
        }

        // ê²°ê³¼ í™”ë©´ì„ ì´ë¯¸ì§€ë¡œ ì €ì¥
        async function exportResultAsImage() {
            const captureArea = document.getElementById('result-capture-area');
            const originalScrollY = appElement.scrollTop;
            
            // ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ ì´ë™í•˜ì—¬ ìº¡ì²˜ ì •í™•ë„ í–¥ìƒ
            appElement.scrollTop = 0;

            try {
                // html2canvas ì˜µì…˜: ìŠ¤ì¼€ì¼(2ë°°) ë° ìŠ¤í¬ë¡¤ í•¸ë“¤ë§
                const canvas = await html2canvas(captureArea, {
                    scale: 2, // ê³ í•´ìƒë„ ì´ë¯¸ì§€ ìƒì„±
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#F3F4F6' // ë°°ê²½ìƒ‰ì„ ìº¡ì²˜ ì˜ì—­ê³¼ ë™ì¼í•˜ê²Œ ì„¤ì •
                });

                // ì´ë¯¸ì§€ ë°ì´í„° URL íšë“
                const imageURL = canvas.toDataURL('image/png');

                // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„± ë° í´ë¦­
                const link = document.createElement('a');
                link.href = imageURL;
                link.download = `${currentSession}_${characterName}_ë°´ë“œëŠ¥ë ¥ì¹˜.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (error) {
                console.error("Image capture failed:", error);
            } finally {
                 // ì›ë˜ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³µì›
                 appElement.scrollTop = originalScrollY;
            }
        }

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ê²°ê³¼ ì €ì¥
        function saveResultLocally(sessionKey) {
            try {
                const dataToSave = {
                    answers: currentAnswers,
                    characterName: characterName,
                    catchphrase: catchphrase,
                    characterImage: characterImage
                };
                localStorage.setItem(STORAGE_KEY_PREFIX + sessionKey, JSON.stringify(dataToSave));
            } catch (e) {
                console.error("Failed to save result locally:", e);
            }
        }

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ê²°ê³¼ ë¡œë“œ
        function loadResultLocally(sessionKey) {
            try {
                const storedData = localStorage.getItem(STORAGE_KEY_PREFIX + sessionKey);
                if (storedData) {
                    const data = JSON.parse(storedData);
                    currentAnswers = data.answers || [];
                    characterName = data.characterName || "ë³´ì»¬ë§¨";
                    catchphrase = data.catchphrase || "ìµœê³ ì˜ ë…¸ë˜ë¥¼ ë“¤ë ¤ì¤„ê²Œ!";
                    characterImage = data.characterImage || null;

                    // ë‹µë³€ì´ 1ê°œë¼ë„ ìˆë‹¤ë©´, ë¡œë“œ í›„ ë§ˆì§€ë§‰ ì§ˆë¬¸ìœ¼ë¡œ ì´ë™ ì¤€ë¹„
                    if (currentAnswers.length > 0) {
                        const totalQuestions = sessionData[currentSession].questions.length;
                        currentQuestionIndex = currentAnswers.length < totalQuestions ? currentAnswers.length : totalQuestions - 1;
                    }
                }
            } catch (e) {
                console.error("Failed to load result locally:", e);
                // ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì´ˆê¸° ìƒíƒœ ìœ ì§€
            }
        }

        // ì•± ì‹œì‘
        document.addEventListener('DOMContentLoaded', () => {
            renderApp();
        });
    </script>
</body>
</html>